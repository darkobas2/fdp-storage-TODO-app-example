name: push to swarm

### run this action when something is pushed to master branch
on:
  push:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
    steps:
      - name: checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Use Node.js ${{ matrix.node-version }}
        uses: pnpm/action-setup@v2
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          version: 7
      - name: Get npm cache directory
        id: npm-cache-dir
        run: |
          echo "::set-output name=dir::$(npm config get cache)"
      - uses: actions/cache@v3
        id: npm-cache # use this to check for `cache-hit` ==> if: steps.npm-cache.outputs.cache-hit != 'true'
        with:
          path: ${{ steps.npm-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-node-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Install npm deps
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: pnpm install
      - name: build
        run: npm run build
        env:
          CI: false

### upload the content of public folder to swarm
      - name: Upload
        id: swarm-upload
        uses: ethersphere/swarm-actions/upload-dir@latest
        with:
          # Fairdatasociety provides a free endpoint for uploading content to swarm
          # use .dev. for testnet uploads
          # or remove .dev. for mainnet uploads
          # or use your own private endpoint
          bee-url: https://gateway.fairdatasociety.org/proxy/
          dir: ./dist
          index-document: index.html
          timeout: 120000

      - name: update feed
        id: swarm-feed
        uses: ethersphere/swarm-actions/write-feed@latest
        with:
          # Same as above regarding bee-url
          bee-url: https://gateway.fairdatasociety.org/proxy/
          # takes the reference from the uploaded dir
          reference: ${{ steps.swarm-upload.outputs.reference }}
          # make up some topic name
          # for example: # openssl rand -hex 16
          topic: d7f07df0942edfba39c76a29f5db65da
          # signer you will want to put into your projects secrets
          # again use some random hex 32 length generation
          # for example: openssl rand -hex 32   and put the output into gihub secrets named "SIGNER"
          # https://docs.github.com/en/actions/security-guides/encrypted-secrets#creating-encrypted-secrets-for-a-repository
          signer: ${{ secrets.SIGNER }}

# print some references of what we just uploaded to swarm
      - name: print references
        run: |
          echo "upload ref: " ${{ steps.swarm-upload.outputs.reference }}  # you can use this to access the content directly https://gateway.dev.fairdatasociety.org/bzz/<refrence>
          echo "CID: " ${{ steps.swarm-cid.outputs.cid }} # same but in cid format
          echo "Feed Manifest: " ${{ steps.swarm-feed.outputs.manifest }}  # note this reference, you will need this in next step to create a persistant reference to it using ENS
